<p id="notice"><%= notice %></p>
<h1>Cats</h1>
<h1>https://jqueryui.com/sortable/#display-grid</h1>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Age</th>
      <th>Color</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @cats.each do |cat| %>
      <tr>
        <td><%= cat.name %></td>
        <td><%= cat.age %></td>
        <td><%= cat.color %></td>
        <td><%= link_to 'Show', cat %></td>
        <td><%= link_to 'Edit', edit_cat_path(cat) %></td>
        <td><%= link_to 'Destroy', cat, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Cat', new_cat_path %>
<hr/>
<%= link_to "Refresh Cats Index", cats_url %>
<br/>

<h2>Create a new cat here</h2
<form id="upload" action="upload.php" method="POST" enctype="multipart/form-data">
  <fieldset>
    <legend>HTML File Upload</legend>
    <input type="hidden" id="MAX_FILE_SIZE" name="MAX_FILE_SIZE" value="300000" />


    <div>
    	<label for="fileselect">Files to upload:</label>
    	<input type="file" id="fileselect" name="fileselect[]" multiple="multiple" />

    	<div id="filedrag" style="padding:55px;">

        <div id="img_holder">
          <ul id="sortable">
          </ul>
        </div>

      </div>
    </div>

    <div id="submitbutton">
    	<button type="submit">Upload Files</button>
    </div>
  </fieldset>
</form>
New Cat Name:<br/>
<input type="text" id="new_cat_name" size="40">
<button type="button" onclick="createCat();">Create Cat</button>

<div id="messages">
</div>

<br/>
<br/>https://stackoverflow.com/questions/18101673/jquery-get-all-src-of-images-in-div-and-put-into-field
<br/>https://www.sitepoint.com/html5-file-drag-and-drop/
<hr/>


<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css">




<style>

.transx
{
    background-color: red;
    opacity: 0.5;
    filter: Alpha(opacity=50);
    z-index: -1;
}

  #filedrag
  {
    display: none;
    font-weight: bold;
    text-align: center;
    padding: 1em 0;
    margin: 1em 0;
    color: #555;
    border: 2px dashed #555;
    border-radius: 7px;
    cursor: default;
  }

  #filedrag.hover
  {
    color: #f00;
    border-color: #f00;
    border-style: solid;
    box-shadow: inset 0 3px 4px #888;
  }
  #sortable { list-style-type: none; margin: 0; padding: 0; width: 450px; }
  #sortable li { margin: 3px 3px 3px 0; padding: 1px; float: left; width: 100px; height: 90px; font-size: 4em; text-align: center; }
</style>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
$( function() {
   $( "#sortable" ).sortable();
   $( "#sortable" ).disableSelection();
 } );
  // getElementById
  function $id(id) {
    return document.getElementById(id);
  }
  // output information
  function Output(msg) {
    var m = $id("messages");
    m.innerHTML = msg + m.innerHTML;
  }
  // call initialization file
  if (window.File && window.FileList && window.FileReader) {
    Init();
  }
  // initialize
  function Init() {
    var fileselect = $id("fileselect"),
    filedrag = $id("filedrag"),
    submitbutton = $id("submitbutton");
    // file select
    fileselect.addEventListener("change", FileSelectHandler, false);

  	// is XHR2 available?
    var xhr = new XMLHttpRequest();
    if (xhr.upload) {
      // file drop
      filedrag.addEventListener("dragover", FileDragHover, false);
      filedrag.addEventListener("dragleave", FileDragHover, false);
      filedrag.addEventListener("drop", FileSelectHandler, false);
      filedrag.style.display = "block";
      // remove submit button
      submitbutton.style.display = "none";
    }
  }
  // file drag hover
  function FileDragHover(e) {
    e.stopPropagation();
    e.preventDefault();
    e.target.className = (e.type == "dragover" ? "hover" : "");
  }

  // file selection
  function FileSelectHandler(e) {
  	// cancel event and hover styling
  	FileDragHover(e);
  	// fetch FileList object
  	var files = e.target.files || e.dataTransfer.files;
  	for (var i = 0; i < files.length; ++i){
    	reader = new FileReader();
  		console.log( reader.readAsDataURL( files[i] ) )
      reader.fileName = files[i].name
      reader.fileArray = []
      reader.onload = function (event,) {
      //  			var img_holder_div = $("#img_holder")[0];
      //  			var img = document.createElement("img");
      var spanx =  document.createElement("span");
      spanx.innerHTML = "test"
      spanx.className = "transx"
      var ul = $("#sortable")[0];
      var li = document.createElement("li");
      var img = document.createElement("img");
      img.width = "100"
      img.src = event.target.result;
      img.setAttribute('data-img-name', event.target.fileName);


      li.appendChild(img);
      li.appendChild(spanx)
      ul.appendChild(li);

  	    //img_holder_div.appendChild(img);
  		};
  	}
    // process all File objects
    for (var i = 0, f; f = files[i]; i++) {
      ParseFile(f);
    }
  }

  function ParseFile(file) {
    Output(
      "<p>File information: <strong>" + file.name +
      "</strong> type: <strong>" + file.type +
      "</strong> size: <strong>" + file.size +
      "</strong> bytes</p>"
    );
  }


  function createCat(){
    var images = $('#img_holder').find('img').map(function() { return { source: this.src, name: $(this).attr("data-img-name") }  }).get()
  //  var names  = $('#img_holder').find('img').map(function() { return $(this).attr("data-img-name") }).get()

    cat_images = []

    for (var i = 0; i < images.length; ++i){
      cat_images.push( {image: images[i]["source"], priority: i } )
      //cat_images.push( {image: images[i], priority: i, name: images[i]["name"] } )
    }

    new_cat_name = $("#new_cat_name").val();
    info = {
      cat:{
        name: new_cat_name,
        attachments_attributes: cat_images
      }
    };

  	jQuery.ajax({
        url: "http://localhost:3000/cats/",
        type: "POST",
        dataType: "JSON",
        data: info,
        success: function (response) {
          // You can see the full response object in
          // Chrome developer tools, console
          // console.log(response)
          window.location.href = "/cats/" + response.id;
          //alert("Name: " + response.name + " ID:" + response.id );
        }
      });

    }


</script>
